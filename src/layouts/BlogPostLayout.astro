---
import BaseLayout from './BaseLayout.astro';
import FormattedDate from '@components/FormattedDate.astro';
import Tag from '@components/Tag.astro';
import TableOfContents from '@components/TableOfContents.astro';
import ReadingProgress from '@components/ReadingProgress.astro';
import Reactions from '@components/Reactions.astro';
import readingTime from 'reading-time';

interface Props {
  post: {
    id: string;
    data: {
      title: string;
      description: string;
      pubDate: Date;
      updatedDate?: Date;
      tags: string[];
      image?: string;
      imageAlt?: string;
    };
    body?: string;
  };
  headings: { depth: number; slug: string; text: string }[];
}

const { post, headings } = Astro.props;
const { title, description, pubDate, updatedDate, tags, image, imageAlt } = post.data;
const stats = readingTime(post.body ?? '');
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

<BaseLayout
  title={title}
  description={description}
  image={image}
  article={true}
  publishedDate={pubDate}
  tags={tags}
>
  <ReadingProgress />
  <article class="relative mx-auto w-full max-w-2xl px-6 py-16">

    {/* Sidebar TOC — desktop only, positioned outside the content column */}
    {filteredHeadings.length > 0 && (
      <aside class="hidden xl:block absolute left-full top-0 bottom-0 ml-10 w-52" aria-label="Table of contents">
        <TableOfContents headings={headings} variant="sidebar" />
      </aside>
    )}

    {image && (
      <div class="mb-10 -mx-6 sm:mx-0 overflow-hidden" style={`border-radius: var(--radius-lg)`}>
        <img
          src={image}
          alt={imageAlt ?? title}
          class="w-full h-auto"
          loading="eager"
          decoding="async"
        />
      </div>
    )}

    <header class="mb-10">
      <h1 class="text-3xl font-bold text-balance sm:text-4xl">
        {title}
      </h1>
      <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-[var(--color-text-secondary)]">
        <FormattedDate date={pubDate} />
        {updatedDate && (
          <span>
            (updated <FormattedDate date={updatedDate} />)
          </span>
        )}
        <span>&middot;</span>
        <span>{stats.text}</span>
      </div>
      {tags.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {tags.map((tag) => <Tag tag={tag} />)}
        </div>
      )}
    </header>

    {/* Inline TOC — mobile/tablet only */}
    {filteredHeadings.length > 0 && (
      <div class="xl:hidden">
        <TableOfContents headings={headings} variant="inline" />
      </div>
    )}

    <div class="prose prose-neutral dark:prose-invert max-w-none">
      <slot />
    </div>

    <div class="mt-12 border-t border-[var(--color-border)] pt-8">
      <Reactions slug={post.id} />
    </div>

    <footer class="mt-8 border-t border-[var(--color-border)] pt-8">
      <a
        href="/blog"
        class="text-sm text-[var(--color-text-secondary)] transition-colors hover:text-[var(--color-text)]"
      >
        &larr; Back to all posts
      </a>
    </footer>
  </article>
</BaseLayout>
