---
// Drop this component in BaseLayout to activate scroll-reveal globally.
// Any element with class="reveal" will fade-in-up when it enters the viewport.
// Add data-delay="100" (ms) for stagger on lists.
---

<script>
  let isFirstLoad = true;

  function initReveal() {
    const els = document.querySelectorAll('.reveal:not(.revealed)');
    if (!els.length) return;

    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // After View Transition navigation or reduced motion: reveal instantly
    if (prefersReduced || !isFirstLoad) {
      els.forEach((el) => {
        el.classList.add('revealed');
        (el as HTMLElement).style.animationDuration = '0s';
      });
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const el = entry.target as HTMLElement;
            const delay = parseInt(el.dataset.delay ?? '0', 10);
            if (delay > 0) {
              setTimeout(() => el.classList.add('revealed'), delay);
            } else {
              el.classList.add('revealed');
            }
            observer.unobserve(el);
          }
        });
      },
      { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
    );

    els.forEach((el) => observer.observe(el));
  }

  document.addEventListener('astro:page-load', () => {
    initReveal();
    isFirstLoad = false;
  });
</script>
